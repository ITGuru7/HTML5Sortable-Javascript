<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<meta name="description" content="HTML5Sortable">
	<meta name="author" content="natalia">

	<title>HTML5 Sortable Project</title>

  <!-- Latest compiled and minified CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css">

	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

	<!-- jQuery library -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

  <!-- Popper JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"></script>

  <!-- Latest compiled JavaScript -->
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"></script>

	<script src="https://cdn.polyfill.io/v2/polyfill.min.js"></script>

	<script src="js/jquery.js"></script>
	<script src="js/underscore.js"></script>

	<!-- Custom styles/js for this template -->
	<link href="css/style.css" rel="stylesheet">
	<script src="js/html5sortable.js"></script>

</head>

<body>

	<!-- The Modal Edit -->
		<div class="modal fade" id="editModal">
			<div class="modal-dialog">
				<div class="modal-content">
			
					<!-- Modal Header -->
					<div class="modal-header">
						<h4 class="modal-title">Edit</h4>
						<button class="close" data-dismiss="modal">&times;</button>
					</div>
			
					<!-- Modal body -->
					<div class="modal-body">
						<textarea rows="10" cols="50" wrap="hard" autofocus></textarea>
					</div>
			
					<!-- Modal footer -->
					<div class="modal-footer">
						<button class="btn btn-save text-white font-weight-bold" data-dismiss="modal">Save</button>
						<button class="btn text-white font-weight-bold" data-dismiss="modal">Cancel</button>
					</div>
			
				</div>
			</div>
		</div>

	<!-- Temp Data -->
		<div>
			<div id="temp-parent" class="row my-4 nested-list d-none">
				<div class="row nested-item bg-transparent w-100">
					<div class="col p-0">
						<i class="fa fa-th text-muted parent-handle"></i>
						<span class="ml-2">Title: </span>
						<label>New Parent</label>
					</div>
					<div class="col p-0">
						<button class="btn btn-add-child py-1 text-white font-weight-bold ml-3 float-right"><i class="fa fa-plus"></i> Add A Lesson</button>
						<button class="btn btn-delete-parent py-1 m-0 text-white font-weight-bold float-right"><i class="fa fa-trash"></i> Delete</button>
						<button class="btn btn-edit py-1 m-0 text-white font-weight-bold float-right" data-toggle="modal" data-target="#editModal"><i class="fa fa-pencil"></i> Edit</button>
					</div>
				</div>

				<div class="container-fluid nested-children-container p-0 pb-1">
				</div>
			</div>

			<div id="temp-child" class="row nested-item nested-child bg-white d-none">
				<div class="col p-0">
					<i class="fa fa-th text-muted child-handle"></i>
					<span class="ml-2">Title: </span>
					<label>New Child</label>
				</div>
				<div class="col p-0">
					<button class="btn btn-delete-child py-1 m-0 text-white font-weight-bold float-right"><i class="fa fa-trash"></i> Delete</button>
					<button class="btn btn-edit py-1 m-0 text-white font-weight-bold float-right" data-toggle="modal" data-target="#editModal"><i class="fa fa-pencil"></i> Edit</button>
				</div>
			</div>

		</div>

	<!-- Main Content -->
		<div id="page-container" class="container my-5 pb-1">

			<div class="row">
				<button class="btn btn-add-parent py-1 text-white font-weight-bold ml-3"><i class="fa fa-plus"></i> Add Nested List</button>
			</div>

		</div>

</body>

<script>

		var m_bEditing = false;

		init_sortable = () => {
			sortable('#page-container', {
				forcePlaceholderSize: true,
//				connectWith: '.js-connected',
				handle: '.parent-handle',
				items: '.nested-list',
				placeholderClass: 'border',
			});
			sortable('.nested-children-container', {
				forcePlaceholderSize: true,
				connectWith: '.js-inner-connected',
				handle: '.child-handle',
				items: '.nested-child',
				maxItems: 10,
				placeholderClass: 'border',
			});
		}

		init_sortable();

		reload_sortable = () => {
			sortable('#page-container');
			sortable('.nested-children-container');
		}

		set_sortable = (mode)  => {
			sortable($('#page-container'), mode);
			sortable($('.nested-children-container'), mode);
		}

		var jsonData = [];
		var edit_element;
		var edit_parent;

		function search_jsonData_byID(data_id) {
			for (i = 0; i < jsonData.length; i ++) {
				if (jsonData[i]['data-id'] == data_id) {
					edit_element = jsonData[i];
					edit_element['index'] = i;
					return edit_element;
				}
			}
		}


	//	load
		$(document).ready(function(){
			var message = {
				'msg-type'	: 'load'
			};
			AJAX(message);
		});

		function onEditTitle() {
			if(m_bEditing == false){
				m_bEditing = true;
				$(this).off('click');
				var label_title = $(this).text();
				$(this).html('<input type=text value="' + label_title + '" autofocus>');
				$('button').prop('disabled', true);
				var button_check = $.parseHTML('<button class="btn btn-end-edit py-1 m-0 text-white"><i class="fa fa-check"></i></button>');
				$(this).parent().append(button_check);
				$(this).parent().find('button.btn-end-edit').on('click', onEndEditTitle);
				set_sortable('disable');
			}
		}
		$('label').on('click', onEditTitle);

	//	update label/content
		function onEndEditTitle() {
			if(m_bEditing == true) {
				m_bEditing = false;
				var label_handler = $(this).parent().find('label');
				label_handler.on('click', onEditTitle);
				var label_title = label_handler.find('input').val();
				label_handler.html(label_title);
				$(this).remove();
				$('button').prop('disabled', false);
				set_sortable('enable');

				var data_id = label_handler.parent().parent().attr('data-id');
				if (data_id == null) {
					data_id = label_handler.parent().parent().parent().attr('data-id');
				}

				edit_element = search_jsonData_byID(data_id);
				var message = {
					'msg-type'		: 'update-label',
					'data-id'		: data_id,
					'data-label'	: label_title, 
				};
				AJAX(message);
			}
		}

		function onEditContent() {
			var data_id = $(this).parent().parent().attr('data-id');
			if (data_id == null) {
				data_id = $(this).parent().parent().parent().attr('data-id');
			}

			edit_element = search_jsonData_byID(data_id);
			$('.modal').find('.modal-title').text(edit_element['data-label']);
			$('.modal').find('.modal-body textarea').val(edit_element['data-content']);
		}

		function onSaveContent() {
			var data_id = edit_element['data-id'];
			var data_content = $('.modal').find('textarea').val();

			edit_element = search_jsonData_byID(data_id);
			var message = {
				'msg-type'		: 'update-content',
				'data-id'		: data_id,
				'data-content'	: data_content,
			};
			AJAX(message);
		}
		$('button.btn-save').on('click', onSaveContent);

	//	delete parent/child
		function onDeleteParent() {
			var data_id = $(this).parent().parent().parent().attr('data-id');
			$(this).parent().parent().parent().remove();
			reload_sortable();

			var message = {
				'msg-type'		: 'delete-parent',
				'data-id'		: data_id,
			};
			AJAX(message);
		}
		$('button.btn-delete-parent').on('click', onDeleteParent);

		function onDeleteChild() {
			var data_id = $(this).parent().parent().attr('data-id');
			$(this).parent().parent().remove();
			reload_sortable();

			var message = {
				'msg-type'		: 'delete-child',
				'data-id'		: data_id,
			};
			AJAX(message);
		}
		$('button.btn-delete-child').on('click', onDeleteChild);

	//	adding parent/child not ready for new data-id
		function addParent(jsonParent) {
			var newParent = $('#temp-parent').clone();
			newParent.attr('id', '');
			newParent.removeClass('d-none');
			newParent.find('button.btn-edit').on('click', onEditContent);
			newParent.find('button.btn-delete-parent').on('click', onDeleteParent);
			newParent.find('button.btn-add-child').on('click', onAddChild);
			newParent.find('label').on('click', onEditTitle);
			newParent.attr('data-id', jsonParent['data-id']);
			newParent.find('label').text(jsonParent['data-label']);
			$('#page-container').append(newParent);

			newParent.find('.nested-children-container').get(0).addEventListener('sortupdate', onSortUpdateChild);
		}
		function onAddParent() {
			var message = {
				'msg-type'		: 'add-parent',
			};
			AJAX(message);
		}
		$('button.btn-add-parent').on('click', onAddParent);

		function addChild(parent, jsonChild) {
			var newChild = $('#temp-child').clone();
			newChild.attr('id', '');
			newChild.removeClass('d-none');
			newChild.find('button.btn-edit').on('click', onEditContent);
			newChild.find('button.btn-delete-child').on('click', onDeleteChild);
			newChild.find('label').on('click', onEditTitle);
			if(jsonChild != null) {
				newChild.attr('data-id', jsonChild['data-id']);
				newChild.find('label').text(jsonChild['data-label']);
			}
			parent.find('.nested-children-container').append(newChild);
		}
		function onAddChild() {
			edit_parent = $(this).parent().parent().parent();
			var data_parent = edit_parent.attr('data-id');
			var message = {
				'msg-type'		: 'add-child',
				'data-parent'	: data_parent,
			};
			AJAX(message);
		}
		$('button.btn-add-child').on('click', onAddChild);

	//	order parent/child
		function onSortUpdateParent(e) {
			var data_id = e.detail.destination.items[e.detail.destination.index].getAttribute('data-id');
			var data_order = e.detail.destination.index + 1;

			var message = {
				'msg-type'		: 'order-parent',
				'data-id'		: data_id,
				'data-order'	: data_order,
			};

			AJAX(message);
		}
		document.querySelector('#page-container').addEventListener('sortupdate', onSortUpdateParent);

		function onSortUpdateChild(e) {
			var data_id = e.detail.destination.items[e.detail.destination.index].getAttribute('data-id');
			var data_order = e.detail.destination.index + 1;
			var old_parent_id = e.detail.origin.container.parentElement.getAttribute('data-id');
			var new_parent_id = e.detail.destination.container.parentElement.getAttribute('data-id');

			var message = {
				'msg-type'		: 'order-child',
				'data-id'		: data_id,
				'data-order'	: data_order,
				'data-parent'	: new_parent_id,
			};

			AJAX(message);
		}
		$('.nested-children-container').each(function( index ) {
			$(this).get(0).addEventListener('sortupdate', onSortUpdateChild);
		});


	//	AJAX message function
		function AJAX(message) {
			$.ajax({
				type: "POST",
				url: "ajax.php",
				data: message,
				success: function(result) {
					result = JSON.parse(result);

					var msg_type = message['msg-type'];
					if (msg_type == 'load') {
						jsonData = result ;
						result.forEach(element => {
							if (element['data-parent'] == null) {	// parent
								addParent(element);
							}
						});
						result.forEach(element => {
							if (element['data-parent'] != null) {	// child
								var parent = $('div[data-id="' + element['data-parent'] + '"]');
								addChild(parent, element);
							}
						});
						reload_sortable();
					}
					else if (msg_type == 'update-label') {
						jsonData[edit_element['index']]['data-label'] = result;
					}
					else if (msg_type == 'update-content') {
						jsonData[edit_element['index']]['data-content'] = result;
					}
					else if (msg_type == 'delete-parent') {
						jsonData = result;
					}
					else if (msg_type == 'delete-child') {
						jsonData = result;
					}
					else if (msg_type == 'order-parent') {
						jsonData = result;
					}
					else if (msg_type == 'order-child') {
						jsonData = result;
					}
					else if (msg_type == 'add-parent') {
						jsonData.push(result);
						addParent(result);
						reload_sortable();
					}
					else if (msg_type == 'add-child') {
						jsonData = result['data'];
						addChild(edit_parent, result['new_child']);
						reload_sortable();
					}
				},
			});
		}

</script>

</html>